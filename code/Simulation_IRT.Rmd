---
title: "Simulation_IRT"
author: "Yiming Chen"
date: "2025-09-09"
output: html_document
---

```{r}
# load packages
library(GDINA)
library(mirt)
library(mvtnorm)
library(dplyr)
library(ggplot2)
```

```{r}
# create folder paths to save data/results/plots
dir.create("../IRT_sim/data", showWarnings = FALSE)
dir.create("../IRT_sim/results", showWarnings = FALSE)
dir.create("../IRT_sim/plots", showWarnings = FALSE)
dir.create("../IRT_sim/plots_single", showWarnings = FALSE)
```

# Data generation and replication
```{r}
set.seed(101)

structure <- c("Simple", "Complex")
correlation <- c(0, 0.3, 0.6)
num_dim <- c(3, 5)
rep <- 10 # 10 datasets for each condition 

# for complex structure: Q-matrix with 3 dimensions
Q_complex_3 <- matrix(c(
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,1,1, 1,1,1, 1,1,1,
            1,1,1, 1,1,1, 1,1,1
        ), ncol = 3, byrow = TRUE)

for (str in structure) {
  for (cor in correlation) {
    for (nd in num_dim) {
      for (rep_id in 1:rep) {
      
      # simulate theta
      r <- matrix(cor, nd, nd)
      diag(r) <- 1
      theta <- rmvnorm(2000, sigma = r)
      
      # simulate discrimination matrix depending on structure
      if (str == "Simple") {
        a <- matrix(NA, nrow = 30, ncol = nd)
        block_size <- 30 / nd
        for (i in 1:nd) {
          start_index <- (i - 1) * block_size + 1
          end_index <- i * block_size
          a[start_index:end_index, i] <- runif(block_size, 0.4, 1.8)
        }
      } else if (str == "Complex" & nd == 3) {
        a <- matrix(NA, nrow = 30, ncol = 3)
        a[Q_complex_3 == 1] <- runif(sum(Q_complex_3 == 1), 0.4, 1.8)
      } else if (str == "Complex" & nd == 5) {
        a <- matrix(NA, nrow = 30, ncol = 5)
        a[sim30GDINA$simQ == 1] <- runif(sum(sim30GDINA$simQ == 1), 0.4, 1.8)
      }
    
      # difficulty intercept
      d <- matrix(rnorm(nrow(a)))
      
      # simulate response data
      data <- simdata(a = a, d = d, itemtype = '2PL', Theta = theta)
      
      # save simulated response data
      dname <- paste0("../IRT_sim/data/data_", str, "_cor", cor, "_dim", nd, "_rep", rep_id, ".csv")
      write.csv(data, dname, row.names = FALSE)
      
      # save true theta
      tname <- paste0("../IRT_sim/data/theta_", str, "_cor", cor, "_dim", nd, "_rep", rep_id, ".csv")
      write.csv(theta, tname, row.names = FALSE)
      }
    }
  }
}
```

# Fit simulated data to two models
Takes ~ 42 minutes to run
```{r}
files <- list.files("../IRT_sim/data", pattern = "^data_.*\\.csv$", full.names = TRUE)

# for complex structure: function to align model specification to Q-matrix
to_model_string <- function(Q){
  factors <- lapply(seq_len(ncol(Q)), function(f){
    items <- which(Q[, f] == 1)
    paste0("F", f, " = ", paste(items, collapse = ","))
  })
  cov <- paste0("COV = ", paste0("F", 1:ncol(Q), collapse = "*"))
  paste(c(factors, cov), collapse = "\n")
}

for (f in files) {
  dat <- read.csv(f)
  
  # extract condition from file names
  fname <- basename(f)

  str <- sub("data_(Simple|Complex)_.*", "\\1", fname)
  cor <- as.numeric(sub(".*cor([0-9.]+)_.*", "\\1", fname))
  nd <- as.numeric(sub(".*dim([0-9]+)_.*", "\\1", fname))
  rep_id <- as.numeric(sub(".*rep([0-9]+)\\.csv", "\\1", fname))
  
  # find matching theta file
  theta_fname <- sub("^data_", "theta_", fname)
  theta_path  <- file.path("../sim_data", theta_fname)
  true_theta  <- read.csv(theta_path)
  
  if (str == "Simple") {
    block_size <- 30 / nd
    Q <- matrix(0, nrow = 30, ncol = nd)
    for (i in 1:nd) {
      start_index <- (i - 1) * block_size + 1
      end_index <- i * block_size
      Q[start_index:end_index, i] <- 1
    }
    factor_lines <- vapply(1:nd, function(i){
      start_index <- (i - 1) * block_size + 1
      end_index <- i * block_size
      paste0("F", i, " = ", paste(start_index:end_index, collapse = ","))
    }, character(1))
    cov_line <- paste0("COV = ", paste0("F", 1:nd, collapse = "*"))
    model_specification <- paste(c(factor_lines, cov_line), collapse = "\n")
    
  } else if (str == "Complex" & nd == 3) {
    Q <- Q_complex_3
    model_specification <- to_model_string(Q)
    
  } else if (str == "Complex" & nd == 5) {
    Q <- sim30GDINA$simQ
    model_specification <- to_model_string(Q)
  }
  
  # fit to MIRT
  # for both 3 & 5 dimensions, use MHRM
  mirt_fit <- mirt(dat, model_specification, method = "MHRM")
    
  # fit to CDM
  gdina_fit <- GDINA(dat, Q, model = "LLM")
  
  # model fit statistics
  # for mirt
  mirt_AIC <- extract.mirt(mirt_fit, "AIC")
  mirt_BIC <- extract.mirt(mirt_fit, "BIC")
  
  if (nd == 5) {
    m2_stats <- M2(mirt_fit, QMC = TRUE)
  } else {
    m2_stats <- M2(mirt_fit)
  }
  
  # for gdina
  gdina_stats <- modelfit(gdina_fit)
  gdina_AIC <- gdina_stats$AIC
  gdina_BIC <- gdina_stats$BIC
  gdina_RMSEA2 <- gdina_stats$RMSEA2          # point estimate
  #gdina_RMSEA_CI <- gdina_stats$RMSEA2.CI   # confidence interval 
  gdina_SRMSR <- gdina_stats$SRMSR
  
  # extract mastery probability
  mp <- personparm(gdina_fit, what = "mp")
  
  # extract person level theta
  if (nd == 5) {
    theta_hat <- fscores(mirt_fit, QMC = TRUE)
  } else {
    theta_hat <- fscores(mirt_fit)
  }
  
  res_obj <- list(
    condition = list(structure = str, correlation = cor, num_dim = nd, replicate = rep_id),
    true_theta = true_theta,
    mp = mp,
    theta_hat = theta_hat,
    mirt_fitstats = list(AIC = mirt_AIC, 
                         BIC = mirt_BIC, 
                         M2 = m2_stats),
    gdina_fitstats = list(AIC = gdina_AIC, 
                          BIC = gdina_BIC, 
                          RMSEA2 = gdina_RMSEA2, 
                          #RMSEA_CI = gdina_RMSEA_CI,
                          SRMSR = gdina_SRMSR)
  )

  # save results to RDS
  fname <- paste0("../IRT_sim/results/res_", str,
                  "_cor", cor,
                  "_dim", nd,
                  "_rep", rep_id, ".rds")
  saveRDS(res_obj, fname)
}
```

# Model evaluation (check correaltion)
```{r}
files <- list.files("../IRT_sim/results", pattern = "^res_.*\\.rds$", full.names = TRUE)

all_results <- list()

for (f in files) {
  result <- readRDS(f)
      
  true_theta <- result$true_theta
  
  eps <- 1e-5
  mp_clip <- pmin(pmax(result$mp, eps), 1 - eps)
  theta_hat <- result$theta_hat
  cond <- result$condition
  
  # correlations
  pearson <- sapply(1:cond$num_dim, function(j)
    cor(qnorm(mp_clip)[, j], theta_hat[, j]))
  spearman <- sapply(1:cond$num_dim, function(j)
    cor(qnorm(mp_clip)[, j], theta_hat[, j], method = "spearman"))
  theta_cor <- sapply(1:cond$num_dim, function(j) 
    cor(theta_hat[, j], true_theta[, j]))
  
  # store results
  all_results[[f]] <- data.frame(
    structure = cond$structure,
    correlation = cond$correlation,
    num_dim = cond$num_dim,
    replicate = cond$replicate,
    factor = paste0("F", 1:cond$num_dim),
    pearson = pearson,
    spearman = spearman,
    theta_cor = theta_cor,
    row.names = NULL
  )
}

result_df_rep <- bind_rows(all_results) %>%
  arrange(
    factor(structure, levels = c("Simple", "Complex")), 
    correlation,                                        
    num_dim,                                             
    replicate                                            
  ) %>%
  mutate(
    pearson = round(pearson, 4),
    spearman = round(spearman, 4),
    theta_cor = round(theta_cor, 4)
  )


result_df_rep
```

```{r}
# should use fisher z transformation 
result_df_rep_12 <- result_df_rep %>%
  group_by(structure, correlation, num_dim) %>%
  summarize(
    mean_pearson = round(mean(pearson), 4),
    mean_spearman = round(mean(spearman), 4),
    mean_theta_cor = round(mean(theta_cor), 4),
    .groups = "drop"
    )

result_df_rep_48 <- result_df_rep %>%
  group_by(structure, correlation, num_dim, factor) %>%
  summarize(
    mean_pearson = round(mean(pearson), 4),
    mean_spearman = round(mean(spearman), 4),
    mean_theta_cor = round(mean(theta_cor), 4),
    .groups = "drop"
    )

result_df_rep_12
result_df_rep_48
```

```{r}
write.csv(result_df_rep, "../IRT_sim/result_df_rep.csv", row.names = TRUE)
#write.csv(result_df_rep_12, "../result_df_rep_12.csv", row.names = TRUE)
#write.csv(result_df_rep_48, "../result_df_rep_48.csv", row.names = TRUE)
```

### Check model fit statistics
```{r}
all_fit_stats <- lapply(files, function(f) {
  res <- readRDS(f)
  data.frame(
    structure   = res$condition$structure,
    correlation = res$condition$correlation,
    num_dim     = res$condition$num_dim,
    replicate   = res$condition$replicate,
    mirt_AIC    = res$mirt_fitstats$AIC,
    mirt_BIC    = res$mirt_fitstats$BIC,
    mirt_RMSEA  = res$mirt_fitstats$M2$RMSEA,
    mirt_SRMSR  = res$mirt_fitstats$M2$SRMSR,
    mirt_TLI    = res$mirt_fitstats$M2$TLI,
    mirt_CFI    = res$mirt_fitstats$M2$CFI,
    mirt_m2     = res$mirt_fitstats$M2$M2,
    mirt_pvalue = res$mirt_fitstats$M2$p,
    gdina_AIC   = res$gdina_fitstats$AIC,
    gdina_BIC   = res$gdina_fitstats$BIC,
    gdina_RMSEA2 = res$gdina_fitstats$RMSEA2,
    #gdina_RMSEA_low = res$gdina_fitstats$RMSEA_CI[1],
    #gdina_RMSEA_up  = res$gdina_fitstats$RMSEA_CI[2],
    gdina_SRMSR = res$gdina_fitstats$SRMSR
  ) 
})

all_fit_stats <- bind_rows(all_fit_stats) %>%
  arrange(
    factor(structure, levels = c("Simple", "Complex")), 
    correlation,                                        
    num_dim,                                             
    replicate                                            
  ) %>% 
  mutate(across(-c(1:4), ~ round(.x, 4)))

all_fit_stats
```

```{r}
write.csv(all_fit_stats, "../IRT_sim/model_fit_stats.csv", row.names = TRUE)
```

# Create correlation plots
```{r}
plot_data <- list()

for (f in files) {
  result <- readRDS(f)
  cond <- result$condition
  
  eps <- 1e-5
  mp_clip <- pmin(pmax(result$mp, eps), 1 - eps)
  theta_hat <- result$theta_hat
  
  for (j in 1:cond$num_dim) {
    plot_data[[length(plot_data) + 1]] <- data.frame(
      structure = cond$structure,
      correlation = cond$correlation,
      num_dim = cond$num_dim,
      replicate = cond$replicate,
      factor = paste0("F", j),
      mp_probit = qnorm(mp_clip)[, j],
      theta_hat = theta_hat[, j]
    )
  }
}

plot_df <- bind_rows(plot_data)

head(plot_df)
# 48 conditions * 10 replicates * 2000 rows = 960,000 rows
dim(plot_df)
```

```{r}
plot_df_avg <- plot_df %>%
  # give each person an index within replicate
  group_by(structure, correlation, num_dim, factor, replicate) %>%
  mutate(person_id = row_number()) %>%
  ungroup() %>%
  # average across the 10 replicates by (condition, factor, person_id)
  group_by(structure, correlation, num_dim, factor, person_id) %>%
  summarise(
    mp_probit = mean(mp_probit),
    theta_hat = mean(theta_hat),
    .groups = "drop"
  )

# 48 conditions * 2000 persons = 96,000 rows
nrow(plot_df_avg)

# each condition-factor have exactly 2000 rows
plot_df_avg %>%
  count(structure, correlation, num_dim, factor) %>%
  arrange(structure, correlation, num_dim, factor)
```

```{r}
# groups variable contains 2000 rows for each of 48 conditions
# the 2000 rows are averaged from 10 replicates 
groups <- plot_df_avg %>%
  group_by(structure, correlation, num_dim, factor) %>%
  group_split()

# labels variable contains 48 conditions with specific structure, cor, num_dim, and factor information
labels <- plot_df_avg %>%
  group_by(structure, correlation, num_dim, factor) %>%
  group_keys()

plots <- list()

for (i in seq_along(groups)) {
  df <- groups[[i]]
  lab <- keys[i, ]
  
  p <- ggplot(df, aes(mp_probit, theta_hat)) +
    geom_point(alpha = 0.3) +
    geom_smooth(method = "lm", se = FALSE, color = "red", formula = y ~ x) +
    labs(
      title = paste0("Structure=", lab$structure,
                     " | Cor=", lab$correlation,
                     " | Dim=", lab$num_dim,
                     " | ", lab$factor),
      x = "Mastery Probability",
      y = "Estimated Theta"
    ) +
    theme_bw()
  
  plots[[i]] <- p
  
  # save plots
  fname <- paste0(
    "plot_", lab$structure,
    "_cor", lab$correlation,
    "_dim", lab$num_dim,
    "_", lab$factor,
    ".png"
  )
  ggsave(file.path("../IRT_sim/plots", fname), plot = p, width = 6, height = 4)
}
```

```{r}
plots
```

```{r}
groups[[1]]
labels[1,]
labels
```

```{r, fig.width=10, fig.height=6, dpi=300}
# facet warp method
ggplot(plot_df_avg, aes(mp_probit, theta_hat)) +
  geom_point(alpha = 0.1) +
  geom_smooth(method = "lm", se = FALSE, color = "red", formula = y ~ x, linewidth = 0.5) +
  facet_grid(structure + correlation ~ num_dim + factor) +
  labs(
      x = "Mastery Probability",
      y = "Estimated Theta"
    ) +
  theme_bw()
```

```{r}
# group_map() function
# plot_df_avg %>%
#   group_by(structure, correlation, num_dim, factor) %>%
#   group_map(~{
#     ggplot(.x, aes(mp_probit, theta_hat)) +
#       geom_point(alpha = 0.3) +
#       geom_smooth(method = "lm", se = FALSE, color = "red", formula = y ~ x) +
#       labs(
#         title = paste0("Structure=", .y$structure,
#                        " | Cor=", .y$correlation,
#                        " | Dim=", .y$num_dim,
#                        " | ", .y$factor),
#         x = "Mastery Probability",
#         y = "Estimated Theta"
#       ) +
#       theme_bw()
#   })
```

# Look at specific conditions that had non-linear correlation plots
```{r}
# structure: Simple; cor = 0, num_dim = 5
# structure: Simple; cor = 0.3, num_dim = 3
path_spec <- c(
  "../IRT_sim/results/res_Simple_cor0_dim5_rep3.rds",
  "../IRT_sim/results/res_Simple_cor0_dim5_rep6.rds",
  "../IRT_sim/results/res_Simple_cor0_dim5_rep9.rds",
  "../IRT_sim/results/res_Simple_cor0.3_dim3_rep4.rds",
  "../IRT_sim/results/res_Simple_cor0.3_dim3_rep7.rds",
  "../IRT_sim/results/res_Simple_cor0.3_dim3_rep10.rds"
)

results_spec <- list()

for (p in path_spec) {
  data_spec <- readRDS(p)
  
  true_theta <- data_spec$true_theta
  theta_hat <- data_spec$theta_hat
  eps <- 1e-5
  mp_clip   <- pmin(pmax(data_spec$mp, eps), 1 - eps)
  cond <- data_spec$condition
  rep_num <- sub(".*_rep([0-9]+)\\.rds", "\\1", basename(p))

  # get correlations
  pearson <- sapply(1:cond$num_dim, function(j) cor(qnorm(mp_clip)[, j], theta_hat[, j]))
  spearman <- sapply(1:cond$num_dim, function(j) cor(qnorm(mp_clip)[, j], theta_hat[, j], method = "spearman"))
  theta_cor <- sapply(1:cond$num_dim, function(j) cor(true_theta[, j], theta_hat[, j]))
  
  # store results to a data frame
  result <- data.frame(
    structure = cond$structure,
    correlation = cond$correlation,
    num_dim = cond$num_dim,
    factor = paste0("F", 1:cond$num_dim),
    replicate = rep_num,
    pearson = round(pearson, 4),
    spearman = round(spearman, 4),
    theta_cor = round(theta_cor, 4),
    row.names = NULL
  )
  
  results_spec[[length(results_spec) + 1]] <- result
      
  for (j in 1:cond$num_dim) {
    plot_df <- data.frame(
      mp_probit <- qnorm(mp_clip)[, j],
      est_theta <- theta_hat[, j]
    )
    
    p <- ggplot(plot_df, aes(x = mp_probit, y = est_theta)) +
      geom_point(alpha = 0.3) +
      geom_smooth(method = "lm", se = FALSE, color = "red", formula = y ~ x) +
      labs(
        title = paste0(
          "Structure = ", cond$structure,
          " | cor = ", cond$correlation,
          " | num_dim = ", cond$num_dim,
          " | Factor F", j,
          " | rep = ", rep_num
        ),
        x = "Mastery Probability",
        y = "Estimated Theta"
      ) +
      theme_bw()
    
    print(p)
    
    # save plots
    fname <- paste0(
      "plot_", cond$structure,
      "_cor", cond$correlation,
      "_dim", cond$num_dim,
      "_Factor", j,
      "_rep", rep_num,
      ".png"
    )
    ggsave(file.path("../IRT_sim/plots_single", fname), plot = p, width = 6, height = 4)
  }
}

do.call(rbind, results_spec)
```

```{r}
result_df_rep %>%
  filter(
    structure == "Simple",
    correlation == 0,
    num_dim == 5,
    replicate %in% c(3, 6, 9))

result_df_rep %>%
  filter(
    structure == "Simple",
    correlation == 0.3,
    num_dim == 3,
    replicate %in% c(4, 7, 10))
```

# Old version: all combined procedure
```{r}
set.seed(101)

structure <- c("Simple", "Complex")
correlation <- c(0, 0.3, 0.6)
num_dim <- c(3, 5)

results_old <- list()
cond_num <- 1

for (str in structure) {
  for (cor in correlation) {
    for (nd in num_dim) {

      # simulate theta
      r <- matrix(cor, nd, nd)
      diag(r) <- 1
      theta <- rmvnorm(2000, sigma = r)

      # simulate discrimination/Q-matrix depending on structure
      if (str == "Simple") {
        a <- matrix(NA, nrow = 30, ncol = nd)
        block_size <- 30 / nd
        for (i in 1:nd) {
          start_index <- (i - 1) * block_size + 1
          end_index <- i * block_size
          a[start_index:end_index, i] <- rlnorm(block_size, 0, 1) # runif(, 0.4, 1.8)
        }

        # align Q matrix to model for simple structure
        factor_lines <- vapply(1:nd, function(i) {
          start_index <- (i - 1) * block_size + 1
          end_index <- i * block_size
          paste0("F", i, " = ", paste(start_index:end_index, collapse = ","))
          }, character(1))
        cov_line <- paste0("COV = ", paste0("F", 1:nd, collapse = "*"))
        model_specification <- paste(c(factor_lines, cov_line), collapse = "\n")

        Q <- (!is.na(a)) * 1

      } else if (str == "Complex" & nd == 3) {
        Q <- Q_complex_3
        a <- matrix(NA, nrow = 30, ncol = 3)
        a[Q == 1] <- rlnorm(sum(Q == 1), 0, 1)
        model_specification <- to_model_string(Q)

      } else if (str == "Complex" & nd == 5) {
        Q <- sim30GDINA$simQ
        a <- matrix(NA, nrow = 30, ncol = 5)
        a[Q == 1] <- rlnorm(sum(Q == 1), 0, 1)
        model_specification <- to_model_string(Q)
      }

      # difficulty parameter
      d <- matrix(rnorm(nrow(a)))

      # simulate data under IRT
      data <- simdata(a = a, d = d, itemtype = '2PL', Theta = theta)

      # fit to mirt
      if (nd == 5) {
        mirt_fit <- mirt(data, model_specification, method = "MHRM")
      } else {
        mirt_fit <- mirt(data, model_specification)
      }
      
      # fit to CDM
      gdina_fit <- GDINA(data, Q)

      # extract mastery probability
      mp <- personparm(gdina_fit, what = "mp")

      # extract person level theta
      if (nd == 5) {
        theta_hat <- fscores(mirt_fit, QMC = TRUE)
      } else {
        theta_hat <- fscores(mirt_fit)
      }

      # set cut point to avoid Inf or -Inf
      eps <- 1e-6 # 0.000001
      mp_clip <- pmin(pmax(mp, eps), 1 - eps)

      # get correlations
      pearson <- sapply(1:nd, function(j) cor(qnorm(mp_clip)[, j], theta_hat[, j]))
      spearman <- sapply(1:nd, function(j) cor(qnorm(mp_clip)[, j], theta_hat[, j], method = "spearman"))

      # store results to a data frame
      results_old[[cond_num]] <- data.frame(
        structure = str,
        correlation = cor,
        num_dim = nd,
        factor = paste0("F", 1:nd),
        pearson = pearson,
        spearman = spearman,
        row.names = NULL
      )

      # correlation plot
      for (j in 1:nd) {
        plot_df <- data.frame(
          mp_probit <- qnorm(mp_clip)[, j],
          est_theta <- theta_hat[, j]
        )
        p <- ggplot(plot_df, aes(x = mp_probit, y = est_theta)) +
                geom_point(alpha = 0.3) +
                geom_smooth(method = "lm", se = FALSE, color = "red", formula = y ~ x) +
                labs(
                  title = paste0("Structure = ", str,
                                " | cor = ", cor,
                                " | num_dim = ", nd,
                                " | Factor F", j),
                  x = "Mastery probability",
                  y = "Estimated theta"
                ) +
                theme_bw()

        print(p)
      }

      cond_num <- cond_num + 1
    }
  }
}

result_df_old <- bind_rows(results_old)
```

```{r}
# result_df_old <- result_df_old %>%
#                     mutate(pearson = round(pearson, 4),
#                            spearman = round(spearman, 4))
#write.csv(result_df, "result_df.csv", row.names = TRUE)
```

# Single condition try-out
## Condition 1
Q : Simple (F1:1-10, F2:11-20, F3: 21-30)
Correlation = 0
Number of dimension = 3

```{r}
set.seed(11)

# simulate theta
r1 <- matrix(0, 3, 3)
diag(r1) <- 1
r1

theta1 <- rmvnorm(2000, sigma=r1)
head(theta1)

# simulate discrimination matrix
a1 <- matrix(NA, nrow=30, ncol=3)
# a1[1:10, 1] <- rlnorm(10, 0, 1)
# a1[11:20, 2] <- rlnorm(10, 0, 1)
# a1[21:30, 3] <- rlnorm(10, 0, 1)

a1[1:10, 1] <- runif(10, 0.4, 1.8)
a1[11:20, 2] <- runif(10, 0.4, 1.8)
a1[21:30, 3] <- runif(10, 0.4, 1.8)

# 30 rows and 3 columns
head(a1)
```

```{r}
set.seed(11)

d1 <- matrix(rnorm(nrow(a1)))

data1 <- simdata(a = a1, d = d1, itemtype = '2PL', Theta = theta1)
head(data1)
```

```{r}
model1 <- '
F1 = 1-10
F2 = 11-20
F3 = 21-30
COV=F1*F2*F3
'

mirt1 <- mirt(data1, model1)
coef(mirt1)
```

```{r}
Q1 <- (!is.na(a1))*1
est1 <- GDINA(data1, Q1)

# extract mastery probability for each attribute
mp1 <- personparm(est1, what = "mp")
head(mp1)

# extract person level theta for all dimensions
est_theta_1 <- fscores(mirt1)
head(est_theta_1)
```
Check model fit with four indices
SRMSR
RMSEA
AIC
BIC
```{r}
# extract RMSEA & SRMSR
M2(mirt1)$RMSEA
M2(mirt1)$RMSEA_5
M2(mirt1)$RMSEA_95
M2(mirt1)$SRMSR

#str(mirt1)

# extract AIC & BIC
mirt1@Fit$AIC
mirt1@Fit$BIC
```
```{r}
M2(mirt1)
```

```{r}
# check overall structure
str(modelfit(est1))

# extract RMSEA/SRMSE/AIC/BIC
modelfit(est1)$RMSEA2       # point estimate
modelfit(est1)$RMSEA2.CI    # confidence interval
modelfit(est1)$SRMSR
modelfit(est1)$AIC
modelfit(est1)$BIC
```

```{r}
# check true theta and estimated theta distributions
plot(est_theta_1[,2], theta1[,2])
plot(density(est_theta_1[,2]))
plot(density(theta1[,2]))

hist(theta1[,1])
hist(est_theta_1[,1])
hist(theta1[,2])
hist(est_theta_1[,2])

cor(est_theta_1[,1], theta1[,1])
cor(est_theta_1[,2], theta1[,2])
```

```{r}
eps <- 1e-5 # 0.00001
mp1_clip <- pmin(pmax(mp1, eps), 1 - eps)

plot(qnorm(mp1[,1]), est_theta_1[,1])
plot(qnorm(mp1[,2]), est_theta_1[,2])
plot(qnorm(mp1[,3]), est_theta_1[,3])

# Pearson correlation
# if there are many -Inf and Inf values --> return NaN when using qnorm()
cor(qnorm(mp1_clip[,1]), est_theta_1[,1])
cor(qnorm(mp1_clip[,2]), est_theta_1[,2])
cor(qnorm(mp1_clip[,3]), est_theta_1[,3])

# Spearman correlation
cor(qnorm(mp1[,1]), est_theta_1[,1], method = "spearman")
cor(qnorm(mp1[,2]), est_theta_1[,2], method = "spearman")
cor(qnorm(mp1[,3]), est_theta_1[,3], method = "spearman")
```

## Condition 7
Q : Complex (GINDA sim30)
Correlation = 0
Number of dimension = 3

```{r}
set.seed(11)

# simulate theta
r7 <- matrix(0, 3, 3)
diag(r7) <- 1
r7

theta7 <- mvtnorm::rmvnorm(2000, sigma=r7)
head(theta7)
```

```{r}
Q <- matrix(c(
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,0,0, 0,1,0, 0,0,1,
            1,1,0, 1,0,1, 0,1,1,
            1,1,1, 1,1,1, 1,1,1,
            1,1,1, 1,1,1, 1,1,1
        ), ncol = 3, byrow = TRUE)

a7 <- matrix(NA, nrow=30, ncol=3)

#a7[Q == 1] <- rlnorm(sum(Q == 1), 0, 1)
a7[Q == 1] <- runif(sum(Q == 1), 0.4, 1.8)
head(a7)
dim(a7)
```

```{r}
set.seed(12)

d7 <- matrix(rnorm(nrow(a7)))

data7 <- simdata(a = a7, d = d7, itemtype = '2PL', Theta = theta7)
head(data7)
```

```{r}
model7 <- to_model_string(Q)
cat(model7)

mirt7 <- mirt(data7, model7)
coef(mirt7)
```

```{r}
Q7 <- (!is.na(a7))*1
est7 <- GDINA(data7, Q7)

# extract mastery probability for each attribute
mp7 <- personparm(est7, what = "mp")
head(mp7)

# extract person level theta for all dimensions
est_theta_7 <- fscores(mirt7)
head(est_theta_7)
```

```{r}
# check true theta and estimated theta distributions
plot(est_theta_7[,2], theta7[,2])
plot(density(est_theta_7[,2]))
plot(density(theta7[,2]))

hist(theta7[,1])
hist(est_theta_7[,1])
hist(theta7[,2])
hist(est_theta_7[,2])

cor(est_theta_7[,1], theta7[,1])
cor(est_theta_7[,2], theta7[,2])
```

```{r}
eps <- 1e-5 # 0.00001
mp7_clip <- pmin(pmax(mp7, eps), 1 - eps)

head(mp7_clip)
head(mp7)
```

```{r}
plot(qnorm(mp7[,1]), est_theta_7[,1])
plot(qnorm(mp7[,2]), est_theta_7[,2])
plot(qnorm(mp7[,3]), est_theta_7[,3])

# Pearson correlation
# if there are many -Inf and Inf values --> return NaN when using qnorm()
cor(qnorm(mp7_clip[,1]), est_theta_7[,1])
cor(qnorm(mp7_clip[,2]), est_theta_7[,2])
cor(qnorm(mp7_clip[,3]), est_theta_7[,3])

# Spearman correlation
cor(qnorm(mp7[,1]), est_theta_7[,1], method = "spearman")
cor(qnorm(mp7[,2]), est_theta_7[,2], method = "spearman")
cor(qnorm(mp7[,3]), est_theta_7[,3], method = "spearman")
```

## Condition 10
Q : Complex (GINDA sim30)
Correlation = 0
Number of dimension = 5

```{r}
set.seed(12)

# simulate theta
r10 <- matrix(0, 5, 5)
diag(r10) <- 1
r10

theta10 <- mvtnorm::rmvnorm(2000, sigma=r10)
head(theta10)
```

```{r}
set.seed(12)
Q <- sim30GDINA$simQ # 30 rows, 5 columns
a10 <- matrix(NA, nrow=30, ncol=5)

#a10[Q == 1] <- rlnorm(sum(Q == 1), 0, 1)
a10[Q == 1] <- runif(sum(Q == 1), 0.4, 1.8)
a10
dim(a10)

d10 <- matrix(rnorm(nrow(a10)))

data10 <- simdata(a = a10, d = d10, itemtype = '2PL', Theta = theta10)
head(data10)
```

```{r}
model10 <- to_model_string(Q)
cat(model10)

mirt10 <- mirt(data10, model10, method = "MHRM")
coef(mirt10)
```

```{r}
# for high-dimension, QMC = T should be set in M2
M2(mirt10, QMC = TRUE)$RMSEA
M2(mirt10, QMC = TRUE)$RMSEA_5
M2(mirt10, QMC = TRUE)$RMSEA_95
M2(mirt10, QMC = TRUE)$SRMSR

# extract AIC & BIC
mirt10@Fit$AIC
mirt10@Fit$BIC
extract.mirt(mirt10, "AIC")
extract.mirt(mirt10, "BIC")
```

```{r}
Q10 <- (!is.na(a10))*1
est10 <- GDINA(data10, Q10, model = "LLM")

# extract mastery probability for each attribute
mp10 <- personparm(est10, what = "mp")
head(mp10)

# extract person level theta for all dimensions
est_theta_10 <- fscores(mirt10, QMC = TRUE)
head(est_theta_10)
```

```{r}
# extract RMSEA/SRMSE/AIC/BIC
modelfit(est10)$RMSEA2       # point estimate
modelfit(est10)$RMSEA2.CI    # confidence interval
modelfit(est10)$SRMSR
modelfit(est10)$AIC
modelfit(est10)$BIC
```

```{r}
# check true theta and estimated theta distributions
plot(est_theta_10[,2], theta10[,2])
plot(density(est_theta_10[,2]))
plot(density(theta10[,2]))

hist(theta10[,1])
hist(est_theta_10[,1])
hist(theta10[,2])
hist(est_theta_10[,2])

cor(est_theta_10[,1], theta10[,1])
cor(est_theta_10[,2], theta10[,2])
```

```{r}
eps <- 1e-5 # 0.00001
mp10_clip <- pmin(pmax(mp10, eps), 1 - eps)

plot(qnorm(mp10[,1]), est_theta_10[,1])
plot(qnorm(mp10[,2]), est_theta_10[,2])
plot(qnorm(mp10[,3]), est_theta_10[,3])

# Pearson correlation
# if there are many -Inf and Inf values --> return NaN when using qnorm()
cor(qnorm(mp10_clip[,1]), est_theta_10[,1])
cor(qnorm(mp10_clip[,2]), est_theta_10[,2])
cor(qnorm(mp10_clip[,3]), est_theta_10[,3])

# Spearman correlation
cor(qnorm(mp10[,1]), est_theta_10[,1], method = "spearman")
cor(qnorm(mp10[,2]), est_theta_10[,2], method = "spearman")
cor(qnorm(mp10[,3]), est_theta_10[,3], method = "spearman")
```
















